# Рефакторинг MainActivity в соответствии с MVVM паттерном

## Обзор изменений

Произведен рефакторинг `MainActivity` для соответствия архитектурному паттерну MVVM (Model-View-ViewModel). Логика, не связанная с интерфейсом, была перенесена в `MainViewModel`.

## Основные изменения

### 1. Создан MainViewModel

**Файл:** `app/src/main/java/com/example/moneyeverydayxml/app/MainViewModel.kt`

**Ответственности:**
- Управление состоянием разрешений на уведомления
- Обработка тестирования уведомлений
- Управление тестовыми транзакциями
- Обновление данных калькулятора
- Проверка debug режима

**LiveData объекты:**
- `notificationPermissionRequired` - статус разрешений на уведомления
- `testNotificationResult` - результаты тестирования уведомлений
- `calculatorDataUpdated` - флаг обновления данных калькулятора

### 2. Рефакторинг MainActivity

**Файл:** `app/src/main/java/com/example/moneyeverydayxml/app/MainActivity.kt`

**Изменения:**
- Удалена бизнес-логика, перенесена в ViewModel
- Добавлены наблюдатели (Observers) для LiveData
- Упрощена структура методов
- Использование Koin для инъекции зависимостей

**Оставшиеся ответственности Activity:**
- Управление жизненным циклом UI
- Обработка пользовательских взаимодействий
- Регистрация BroadcastReceiver
- Отображение Snackbar уведомлений

### 3. Обновление модуля Koin

**Файл:** `app/src/main/java/com/example/moneyeverydayxml/app/di/AppModule.kt`

Добавлена регистрация `MainViewModel` в контейнер зависимостей.

### 4. Создание тестов

**Файл:** `app/src/test/java/com/example/moneyeverydayxml/app/MainViewModelTest.kt`

Создан комплексный набор unit-тестов для `MainViewModel` с использованием:
- MockK для мокирования зависимостей
- Koin Test для тестирования инъекции зависимостей
- Coroutines Test для тестирования асинхронных операций
- InstantTaskExecutorRule для тестирования LiveData

## Архитектурные принципы

### Разделение ответственностей

**ViewModel (MainViewModel):**
- Бизнес-логика
- Управление состоянием
- Обработка данных
- Взаимодействие с репозиториями

**View (MainActivity):**
- Отображение UI
- Обработка пользовательских событий
- Управление жизненным циклом
- Навигация

**Model:**
- Сущности данных
- Репозитории
- Источники данных

### Реактивное программирование

Использование LiveData для реактивного обновления UI:
- Автоматическое обновление при изменении данных
- Управление жизненным циклом
- Предотвращение утечек памяти

### Инъекция зависимостей

Использование Koin для:
- Управления зависимостями
- Упрощения тестирования
- Слабой связанности компонентов

## Преимущества рефакторинга

### 1. Тестируемость
- ViewModel легко тестируется без Android фреймворка
- Изолированная бизнес-логика
- Мокирование зависимостей

### 2. Поддерживаемость
- Четкое разделение ответственностей
- Упрощенная структура кода
- Легкость внесения изменений

### 3. Расширяемость
- Модульная архитектура
- Возможность добавления новых функций
- Переиспользование компонентов

### 4. Производительность
- Оптимизированное управление жизненным циклом
- Эффективное обновление UI
- Предотвращение утечек памяти

## Тестирование

### Unit-тесты для MainViewModel

```kotlin
@Test
fun `checkNotificationPermissions_whenServiceDisabled_shouldSetPermissionRequiredToTrue`() {
    // Given
    every { mockNotificationPermissionManager.isNotificationServiceEnabled() } returns false

    // When
    viewModel.checkNotificationPermissions()

    // Then
    val result = viewModel.notificationPermissionRequired.getOrAwaitValue()
    assertTrue(result)
}
```

### Запуск тестов

```bash
./gradlew test
```

## Заключение

Рефакторинг успешно перенес логику из Activity в ViewModel, что соответствует принципам MVVM архитектуры. Код стал более тестируемым, поддерживаемым и расширяемым. Добавлены comprehensive unit-тесты для обеспечения качества кода. 